<!DOCTYPE html>
<html>
<head>
    <title>Coderlmn's Char Image Tool</title>
    <style>
        span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-family: monospace;
            line-height: 0;
            font-size: 8px;
            font-weight: bolder;
        }
        input {
            background-color: darkslategray;
            color: white;
            padding-top: 20px;
            vertical-align: middle;
            text-align: center;
        }
        input, button, label {
            min-height: 50px;
            min-width: 100px;
            font-size: 25px;
        }
    </style>
</head>
<body>
    <label for="canvas">Click to rotate: </label><canvas id="canvas" onclick="rot()"></canvas>
    <label for="file">Photo: </label> <input type="file" accept="image/*" id="file" onchange="selectFile(this)" size="20"/>
    <label for="dimension">Size:  </label><input id="dimension" type='number' accept="" value="150" min="50" max="300" step="10" onchange="setDim(this)" size="20"/>
    <button name="ok" type="submit" onclick="regen()" size="20">ok</button>
    <hr>
    <span id='char'></span>
    <script>
        var charSpan = document.getElementById('char');
        var canvas = document.getElementById('canvas');
        var context = canvas.getContext('2d');
        var dimension = 150, imageObj = new Image();
        var charColor = [];
        for(var n=0; n<=256; n++){
            if(n<10) charColor[n] = 'M';
            else if(n<20) charColor[n] = 'W';
            else if(n<40) charColor[n] = 'B';
            else if(n<60) charColor[n] = 'R';
            else if(n<80) charColor[n] = 'H';
            else if(n<100) charColor[n] = 'J';
            else if(n<120) charColor[n] = 'I';
            else if(n<140) charColor[n] = 't';
            else if(n<160) charColor[n] = 'r';
            else if(n<180) charColor[n] = '+';
            else if(n<200) charColor[n] = '~';
            else if(n<220) charColor[n] = '-';
            else if(n<240) charColor[n] = ':';
            else charColor[n] = '&nbsp;';
        }                       // set replacing characters for the ranges of gray scales

        var setDim = function(element){
            var dim = parseInt(element.value);
            if(dim){
                dimension = dim;
            }
        };
        var regen = function(){
            generate(imageObj);
        };
        var rot = function(){
            rotate(imageObj);
        };
        var selectFile = function(element) {    //select image files within the photos directory
            var file = element.files[0];
            var fileLoader = new FileReader();
            if (file.type.match('image.*')) {
                fileLoader.readAsDataURL(file);
            }
            // when the fileloader has the file object, it passes data to the image object,
            // which will triggers the imageObj onload function once the image has loaded.
            fileLoader.onload = function() {
                imageObj.src = this.result;
            };
            imageObj.onload = function() {
                // Check for empty images
                if(this.width > 0 || this.height > 0){
                    generate(this);
                }
            };
        };
        var generate = function(imgobj){
            var wid = dimension;
            var hei = Math.round(imgobj.height*dimension/imgobj.width);           //default drawing area
            //use the canvas object to create the new resized image data
            canvas.width = wid;
            canvas.height  = hei;
            context.clearRect(0,0,wid,hei);
            //draw the resized image on the canvas
            context.drawImage(imgobj, 0, 0, imgobj.width, imgobj.height, 0, 0, wid, hei);
            var imageData = context.getImageData(0, 0, wid, hei);             //get bitmap of the image
            produce(imageData.data, wid);
        };
        var rotate = function(imgobj){
            var hei = dimension;
            var wid = Math.round(imgobj.height*dimension/imgobj.width);           //default drawing area
            //set transform to rotate the canvas
            canvas.width = wid;
            canvas.height  = hei;
            var scale = wid / imgobj.height; // how much to scale the image to fit
            context.setTransform(
                    0,scale, // x axis down the screen
                    -scale,0, // y axis across the screen from right to left
                    wid,    // x origin is on the right side of the canvas
                    0         // y origin is at the top
            );
            context.drawImage(imgobj,0,0);
            var imageData = context.getImageData(0, 0, wid, hei);             //get bitmap
            produce(imageData.data, wid);
        };
        var produce = function(data, wid){
            colorString = '';
            charSpan.innerHTML = '';      //clear previous output
            for (var i = 4; i < data.length; i += 4) {
                var avg = Math.round((data[i] + data[i+1] + data[i + 2]) / 3);// calculate the gray scale of one pixel
                colorString += charColor[avg];                                // get the corresponding character
                if(i%(wid*4) == 0) {
                    charSpan.innerHTML += '<p>'+ colorString +'</p>';         // produce one line of the text image
                    colorString = '';
                }
            }          // generate the character image string
        }
    </script>
</body>
</html>
